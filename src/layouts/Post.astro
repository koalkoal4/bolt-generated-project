---
// src/layouts/Post.astro
import BaseLayout from './Base.astro';
const { frontmatter } = Astro.props;
const allPosts = await Astro.glob('../pages/posts/*.md');

// Helper function to normalize URL paths
const normalizePath = (path) => {
  return path.replace(/\/$/, ''); // Remove trailing slash
};

// Filter out the current post using normalized paths
const otherPosts = allPosts.filter(post => normalizePath(post.url) !== normalizePath(Astro.url.pathname));

const currentTags = frontmatter.tags || []; // Get current post's tags, default to empty array

// Find posts with at least one common tag
const relatedPosts = otherPosts.filter(post => {
  const postTags = post.frontmatter.tags || [];
  // Check if any tag in postTags exists in currentTags
  return postTags.some(tag => currentTags.includes(tag));
});

// Determine suggested posts: prioritize related, fill with recent if needed
const MAX_SUGGESTIONS = 3;
let suggestedPosts = relatedPosts.slice(0, MAX_SUGGESTIONS);

// If we don't have enough related posts, fill with recent ones
if (suggestedPosts.length < MAX_SUGGESTIONS) {
  const relatedUrls = suggestedPosts.map(post => normalizePath(post.url));
  const recentPosts = otherPosts
    .filter(post => !relatedUrls.includes(normalizePath(post.url))) // Exclude already selected related posts
    .sort((a, b) => new Date(b.frontmatter.date).valueOf() - new Date(a.frontmatter.date).valueOf());

  const needed = MAX_SUGGESTIONS - suggestedPosts.length;
  suggestedPosts = suggestedPosts.concat(recentPosts.slice(0, needed));
}
---
<BaseLayout 
  title={frontmatter.title + " | Trained Tails Blog"}
  description={frontmatter.description}
  image={frontmatter.image}
  type="article"
  publishDate={frontmatter.date}
>
  <article class="max-w-4xl mx-auto px-4 py-8 prose prose-slate dark:prose-invert lg:prose-lg">
    {/* Breadcrumbs */}
    <nav class="flex text-sm text-slate-500 dark:text-slate-400 mb-6 not-prose" aria-label="Breadcrumb">
      <ol class="inline-flex items-center space-x-1 md:space-x-3">
        <li class="inline-flex items-center">
          <a href="/" class="inline-flex items-center hover:text-blue-600 dark:hover:text-blue-400 transition-colors">
            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
            Home
          </a>
        </li>
        <li>
          <div class="flex items-center">
            <svg class="w-6 h-6 text-slate-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
            <a href="/blog" class="ml-1 md:ml-2 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Blog</a>
          </div>
        </li>
        <li aria-current="page">
          <div class="flex items-center">
            <svg class="w-6 h-6 text-slate-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
            <span class="ml-1 md:ml-2 text-slate-400 dark:text-slate-500 truncate max-w-[200px] sm:max-w-xs">{frontmatter.title}</span>
          </div>
        </li>
      </ol>
    </nav>

    <h1 class="text-3xl md:text-4xl font-bold mb-2">{frontmatter.title}</h1>
    <p class="text-sm text-slate-500 dark:text-slate-400 mb-8">
      Published on: {new Date(frontmatter.date).toLocaleDateString()}
      {frontmatter.tags && frontmatter.tags.length > 0 && (
        <span class="ml-4 hidden">Tags: {frontmatter.tags.join(', ')}</span>
      )}
    </p>
    {frontmatter.image && <img src={frontmatter.image} alt={frontmatter.title + " hero image"} class="w-full h-auto rounded-xl mb-8 shadow-lg" loading="lazy" />}

    {/* Markdown content goes here */}
    <slot />
  </article>

  {/* Suggested Posts Section */}
  {/* Always render the section wrapper */}
    <section class="max-w-4xl mx-auto px-4 py-12 mt-12 border-t border-slate-200 dark:border-slate-700">
      <h2 class="text-2xl md:text-3xl font-bold text-slate-800 dark:text-slate-100 mb-8 text-center">You Might Also Like</h2>
      <div class="grid gap-6 sm:gap-8 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 not-prose"> {/* Added not-prose */}
        {suggestedPosts.map(post => (
          <article class="bg-white dark:bg-slate-800 rounded-xl shadow-md overflow-hidden hover:shadow-lg transition-shadow flex flex-col">
            {post.frontmatter.image && (
              <a href={post.url} class="block">
                <img src={post.frontmatter.image} alt={post.frontmatter.title + " preview"} class="w-full h-40 object-cover" loading="lazy" /> {/* Adjusted height */}
              </a>
            )}
            <div class="p-4 sm:p-5 flex flex-col flex-grow"> {/* Adjusted padding */}
              <h3 class="text-lg sm:text-xl font-semibold mt-1 mb-2 flex-grow dark:text-white"> {/* Adjusted size/margin */}
                <a href={post.url} class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors">{post.frontmatter.title}</a>
              </h3>
              <p class="text-slate-600 dark:text-slate-300 mb-3 text-sm line-clamp-3">{post.frontmatter.description}</p> {/* Added line-clamp */}
              <div class="mt-auto">
                 <a href={post.url} class="text-blue-600 dark:text-blue-400 hover:underline text-sm font-medium">Read more â†’</a>
              </div>
            </div>
          </article>
        ))}
      </div>
    </section>
  {/* End of section wrapper */}
</BaseLayout>
