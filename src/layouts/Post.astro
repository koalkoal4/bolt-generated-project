---
// src/layouts/Post.astro
import BaseLayout from './Base.astro';
const { frontmatter } = Astro.props;

// Get all posts for suggestions
const allPosts = await Astro.glob('../pages/blog/*.md');
const currentPostSlug = Astro.url.pathname;

// Filter out current post and sort by date (newest first)
const filteredPosts = allPosts
  .filter(post => post.url !== currentPostSlug)
  .sort((a, b) => new Date(b.frontmatter.date) - new Date(a.frontmatter.date));

// Function to get random suggestions
function getRandomSuggestions(posts, count = 3) {
  // Create a copy of the array to avoid mutation
  const shuffled = [...posts].sort(() => 0.5 - Math.random());
  return shuffled.slice(0, count);
}

const suggestedPosts = getRandomSuggestions(filteredPosts);
---
<BaseLayout title={frontmatter.title + " | Trained Tails Blog"}>
  <article class="max-w-4xl mx-auto px-4 py-8 prose prose-slate dark:prose-invert lg:prose-lg">
    <h1 class="text-3xl md:text-4xl font-bold mb-2">{frontmatter.title}</h1>
    <p class="text-sm text-slate-500 dark:text-slate-400 mb-8">
      Published on: {new Date(frontmatter.date).toLocaleDateString()}
      {frontmatter.tags && frontmatter.tags.length > 0 && (
        <span class="ml-4">Tags: {frontmatter.tags.join(', ')}</span>
      )}
    </p>
    {frontmatter.image && <img src={frontmatter.image} alt={frontmatter.title + " hero image"} class="w-full h-auto rounded-xl mb-8 shadow-lg" loading="lazy" />}
    
    {/* Markdown content goes here */}
    <slot />

    {/* Suggested Posts Section */}
    {suggestedPosts.length > 0 && (
      <div class="mt-16 not-prose">
        <h2 class="text-2xl font-bold mb-6 text-slate-800 dark:text-slate-200">You Might Also Like</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          {suggestedPosts.map(post => (
            <a href={post.url} class="group block">
              <div class="overflow-hidden rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300 bg-white dark:bg-slate-800 h-full">
                {post.frontmatter.image && (
                  <img 
                    src={post.frontmatter.image} 
                    alt={post.frontmatter.title} 
                    class="w-full h-48 object-cover group-hover:scale-105 transition-transform duration-300"
                    loading="lazy"
                  />
                )}
                <div class="p-4">
                  <h3 class="font-semibold text-lg mb-2 text-slate-800 dark:text-slate-200 group-hover:text-blue-600 dark:group-hover:text-blue-400">
                    {post.frontmatter.title}
                  </h3>
                  <p class="text-sm text-slate-600 dark:text-slate-400">
                    {new Date(post.frontmatter.date).toLocaleDateString()}
                  </p>
                </div>
              </div>
            </a>
          ))}
        </div>
      </div>
    )}
  </article>
</BaseLayout>